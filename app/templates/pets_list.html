{% extends "base.html" %}
{% block content %}
<h2>Pets</h2>
<div class="top-actions"><a class="btn" href="/pets/new">New Pet</a></div>
<form method="get" style="background:#fff; padding:12px; border:1px solid #e5e7eb; margin-bottom:12px; position:relative;">
  <label>Search</label>
  <div style="position:relative;">
    <input type="text" id="pet-search" name="q" value="{{ q }}" placeholder="Pet name, registration, breed, or owner" autocomplete="off" />
    <button type="button" id="pet-search-clear" style="position:absolute; right:8px; top:6px;">✕</button>
  </div>
  <div id="pet-search-results" style="display:none; position:absolute; background:#fff; border:1px solid #e5e7eb; width:calc(100% - 24px); z-index:10;"></div>
  <label>Species</label>
  <input type="text" name="species" value="{{ species }}" placeholder="Dog/Cat/Other" />
  <label>Gender</label>
  <select name="gender">
    <option value=""></option>
    <option value="male" {% if gender == "male" %}selected{% endif %}>male</option>
    <option value="female" {% if gender == "female" %}selected{% endif %}>female</option>
    <option value="unknown" {% if gender == "unknown" %}selected{% endif %}>unknown</option>
  </select>
  <label>Sort</label>
  <select name="sort">
    <option value=""></option>
    <option value="name" {% if sort == "name" %}selected{% endif %}>name</option>
  </select>
  <div style="margin-top:8px;">
    <button type="submit">Apply</button>
  </div>
</form>
<table>
  <tr><th>Name</th><th>Species</th><th>Gender</th><th>Pet Parent</th><th>Actions</th></tr>
  {% for pet in pets %}
  <tr>
    <td>{{ pet.name }}</td>
    <td>{{ pet.species }}</td>
    <td>{{ pet.gender }}</td>
    <td>{{ parent_map[pet.pet_parent_id].name if parent_map.get(pet.pet_parent_id) }}</td>
    <td class="actions">
      <a class="btn-secondary btn" href="/pets/{{ pet.id }}">View</a>
      <a class="btn-secondary btn" href="/pets/{{ pet.id }}/edit">Edit</a>
      <form method="post" action="/pets/{{ pet.id }}/delete">
        <button class="btn-danger" type="submit">Delete</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>

<script>
  const searchInput = document.getElementById('pet-search');
  const results = document.getElementById('pet-search-results');
  const clearBtn = document.getElementById('pet-search-clear');
  let timer = null;

  function clearResults() {
    results.style.display = 'none';
    results.innerHTML = '';
  }

  function renderResults(items) {
    if (!items.length) {
      clearResults();
      return;
    }
    results.innerHTML = '';
    items.forEach((item) => {
      const div = document.createElement('div');
      div.style.padding = '6px 8px';
      div.style.cursor = 'pointer';
      div.textContent = `${item.name} (${item.breed || 'Unknown'}) — ${item.owner || ''}`;
      div.addEventListener('click', () => {
        window.location.href = `/pets?q=${encodeURIComponent(item.name)}`;
      });
      results.appendChild(div);
    });
    results.style.display = 'block';
  }

  async function doSearch(q) {
    const resp = await fetch(`/api/pets/search?q=${encodeURIComponent(q)}`);
    if (!resp.ok) {
      clearResults();
      return;
    }
    const data = await resp.json();
    renderResults(data);
  }

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim();
    if (timer) clearTimeout(timer);
    if (!q) {
      clearResults();
      return;
    }
    timer = setTimeout(() => doSearch(q), 300);
  });

  clearBtn.addEventListener('click', () => {
    window.location.href = '/pets';
  });

  document.addEventListener('click', (e) => {
    if (!results.contains(e.target) && e.target !== searchInput) {
      clearResults();
    }
  });
</script>

{% endblock %}
